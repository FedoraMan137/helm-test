title Pub/Sub Message Flow between Microservices and Redis

participant Sender
participant "Online Client" as Online

participant Load Balancer

participant Microservice A
participant Microservice B
participant Redis
participant "Redis or PG\nOnline Client List" as Online List
participant Cloud Notifications


participant "Offline Client" as Offline

Online-#blue>Load Balancer:Client goes Online\nLoad balancer assigns any \nMediator instance
loop Message Processing
Sender-#red>Load Balancer:Send Message to Client\nLoad Balancer assigns Mediator A instance
Load Balancer-#red>Microservice A:Send Message to Client
    alt Message for Online Client (Microservice A)
Online-#blue>Microservice A:SignalR Channel @ A\nLoad balancer assigned client to A
Microservice A <<-->> Redis:Subscribe to Redis channel 'notification_channel A'
Microservice A-#orange>Online List:Set Online is Online @ A
Microservice A-#red>>Microservice A:Handle Message notification event
Microservice A<-#orange>Online List:Check Online status of Online and where connection is
Microservice A->Microservice A:Client is Connected here
Microservice A-#blue>>Online:Send notification to Online Client
    else Message for Online Client (Microservice B)
Online-#blue>Microservice B:SignalR Chanel @ B\nLoad balancer assigned client to B
Microservice B <<-->> Redis:Subscribe to Redis channel 'notification_channel A'
Microservice B-#orange>Online List:Set Client is online @ B
Microservice A-#red>>Microservice A:Handle Message notification event
Microservice A<-#orange>Online List:Check Online status of Online and where connection is
Microservice A->Microservice A:Client is connected @ B
        Microservice A --#red>> Redis:Publish notification to Redis channel 'notification_channel A'
Microservice B<<#red--Redis:Read event from 'notification_channel A' 
Microservice B --#purple>> Microservice B: Handle Redis notification event
Microservice B-#blue>>Online:Send notification to Online Client
    else Message for Offline Client
Microservice A-#red>>Microservice A:Handle Message notification event
Microservice A<-#orange>Online List:Check Online status of client and where connection is if any
Microservice A->Microservice A:Client is OFFLINE
Microservice A-#green>>Cloud Notifications:Publish cloud notification to Redis channel 'cloud_notification_channel'
Cloud Notifications-#green>Offline:Send to Offline Client
    end
end


